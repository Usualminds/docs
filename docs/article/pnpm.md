# pnpm
![](./assets/pnpm/pnpm.svg)

## èƒŒæ™¯
å¦‚æœä½ ä»äº‹è¿‡å‰ç«¯æ–¹é¢çš„å·¥ä½œå’Œå¼€å‘ï¼Œç›¸ä¿¡ä½ å¯¹ `npm` å’Œ `yarn` è¿™æ ·çš„å·¥å…·å·²ç»å†ç†Ÿæ‚‰ä¸è¿‡äº†ã€‚ä½œä¸ºåŒ…ç®¡ç†å·¥å…·ï¼Œ`npm` å·²ç»æœ‰äº†é•¿è¶³çš„[å†å²](https://github.com/npm/cli/blob/latest/changelogs/CHANGELOG-1.md)ã€‚ä¸€ä¸ªé¡¹ç›®åˆå§‹åŒ–è¿‡ç¨‹éƒ½éœ€è¦é€šè¿‡ `npm install` å‘½ä»¤å®‰è£…ç›¸å…³çš„ä¾èµ–åˆ° `node_modules` ç›®å½•ä¸‹,å¯¹äºè¾ƒå¤§å‹çš„å‰ç«¯é¡¹ç›®ï¼Œ`node_modules` çš„å¤§å°å¾ˆå¤šæ—¶å€™æ˜¯è¶…ä¹æˆ‘ä»¬æƒ³è±¡çš„ã€‚è€Œ `npm` åœ¨ç‰ˆæœ¬æ›´æ–°è¿­ä»£çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¸€ç›´åœ¨ä¼˜åŒ–è¿™ä¸ªé—®é¢˜ï¼Œä¸‹é¢æˆ‘ä»¬å°±ç®€è¦èŠèŠ `npm` çš„å‘å±•å†ç¨‹ã€‚

## npm å‘å±•

### npm2 

åœ¨ `npm2` å‘å±•é˜¶æ®µï¼Œå®‰è£…ä¾èµ–æ˜¯ç›¸å¯¹æ¯”è¾ƒç›´æ¥çš„ï¼Œå®ƒä¼šç›´æ¥æŒ‰ç…§é…ç½®æ–‡ä»¶ `package.json` ä¸­çš„ä¾èµ–é¡¹å»ä¸‹è½½ç›¸å…³ä¾èµ–åŒ…ï¼Œè€Œä¾èµ–åŒ…çš„ç»„ç»‡å½¢å¼åˆ™æ˜¯æŒ‰ç…§æ ‘å½¢ç»“æ„å»æ’åˆ—çš„ã€‚ç”±äºä¸åŒçš„åŒ…çš„ä¾èµ–å…³ç³»åœ¨ç‰ˆæœ¬ä¸Šå·®å¼‚è¾ƒå¤§ï¼Œä¾èµ–å…³ç³»ç›¸å¯¹å¤æ‚ï¼Œæ‰€ä»¥ `npm2` ç›´æ¥æŒ‰ç…§é…ç½®å»ä¸‹è½½å¹¶ç»„ç»‡ä¾èµ–çš„æ–¹å¼ï¼Œæ˜¯ç®€å•æ˜æ™°çš„åšæ³•ï¼Œä¿è¯äº†å„ä¸ªä¾èµ–çš„ç‹¬ç«‹æ€§ï¼Œåœ¨ä¾èµ–å˜æ›´æ—¶ï¼Œç›¸äº’å¹¶ä¸å½±å“ï¼Œå…¶å…³ç³»å¯ä»¥é€šè¿‡ä¸‹å›¾æ¥æè¿°ï¼š

![](./assets/pnpm/node_modules_npm2.png)

ä»ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°
1. `A`ã€`B`ã€`C` åŒ…ç›¸äº’ç‹¬ç«‹
2. `A`ã€`B`ã€`C` åŒ…å¯èƒ½ä¼šä¾èµ–ç›¸åŒçš„åŒ…ï¼Œæ¯”å¦‚ **`D@1.0`**
3. `A`ã€`B`ã€`C` åŒ…å¯èƒ½ä¼šå­˜åœ¨è¾ƒæ·±çš„ä¾èµ–å±‚çº§ï¼Œæ¯”å¦‚ **`C package`**

å…¶ä¸­ `2` å’Œ `3` è¿™ä¸¤ç‚¹çš„è´Ÿé¢å½±å“ä¼šéšç€é¡¹ç›®å¤æ‚åº¦è€Œä¸Šå‡ï¼Œå¯èƒ½ä¼šå¯¼è‡´çš„å‡ ä¸ªé—®é¢˜
- è¾ƒå¤§çš„å†—ä½™ã€‚å¤šæ¬¡ä¸‹è½½çš„ç›¸åŒçš„ä¾èµ–åŒ… **`D@1.0`**ï¼Œæ— æ³•å®ç°å…±äº«
- è¾ƒæ·±å±‚çº§çš„ä¾èµ–æ ‘ã€‚
  - `node_modules` ä¾èµ–åŒ…è·¯å¾„è¿‡é•¿ï¼Œè¶…å‡ºæ“ä½œç³»ç»Ÿæœ€é•¿è·¯å¾„é™åˆ¶ï¼ˆ `windows`ï¼š`260` å­—ç¬¦ï¼Œ`macos`ï¼š`1024` å­—ç¬¦ï¼‰ï¼Œå‚è§ï¼š
    - [Too many dependencies break the Windows file system](https://github.com/npm/npm/issues/3697) 
    - [Maximum Path Length Limitation](https://docs.microsoft.com/en-us/windows/win32/fileio/maximum-file-path-limitation?tabs=cmd)
    - [Why does the 260 character path length limit exist in Windows?](https://stackoverflow.com/questions/1880321/why-does-the-260-character-path-length-limit-exist-in-windows)
  - å¤ªæ·±çš„å±‚çº§å¯¼è‡´æ–‡ä»¶æŸ¥æ‰¾å¤æ‚åº¦ä¸Šå‡ï¼Œä¸¥é‡å½±å“æ€§èƒ½ï¼Œå¢åŠ è€—æ—¶ 

> Note: é€šè¿‡ `npm ls --depth=n` æŸ¥çœ‹é¡¹ç›®ç›¸å…³ä¾èµ–å±‚çº§æ·±åº¦

### npm3
ä¸ºè§£å†³ `npm2` ä¸­å­˜åœ¨çš„å†—ä½™å’Œä¾èµ–æ ‘é—®é¢˜ï¼Œ`npm3` å¯¹ä¾èµ–é¡¹è¿›è¡Œäº†[ä¾èµ–æ‰å¹³åŒ–è®¨è®ºå’Œå¤„ç†](https://github.com/npm/cli/blob/latest/changelogs/CHANGELOG-3.md)

![](https://tva1.sinaimg.cn/large/008i3skNgy1gyt34wicfwj31ka0emjvk.jpg)

æ‰å¹³åŒ–å…·ä½“æ¥è®²å°±æ˜¯ä¾èµ–ä¸åœ¨æŒ‰ç…§æ ‘å‹è¿›è¡Œå®‰è£…ï¼Œè€Œæ˜¯å®‰è£…å°†ä¾èµ–å®‰è£…åœ¨åŒçº§ç›®å½•ä¸‹ï¼Œ`npm install` å®‰è£…ä¾èµ–æ—¶ï¼Œä¼šæŒ‰ç…§é…ç½®æ–‡ä»¶ `package.json` é‡Œçš„ä¾èµ–é¡ºåºè¿›è¡Œè§£æï¼Œé‡åˆ°æ–°åŒ…å°±æŠŠå®ƒæ”¾åœ¨ç¬¬ä¸€å±‚çº§çš„ç›®å½•ï¼ˆå¦‚ **`D@1.0`ã€`E@1.0`ã€`F@1.0`**ï¼‰ï¼Œåé¢å¦‚æœé‡åˆ°ç¬¬ä¸€çº§ç›®å½•å·²æœ‰çš„åŒ…ï¼Œä¼šå…ˆè¿›è¡Œä¾èµ–ç‰ˆæœ¬åˆ¤æ–­ï¼Œå¦‚æœç‰ˆæœ¬ä¸€æ ·åˆ™å¿½ç•¥ï¼Œå¦åˆ™ä¼šæŒ‰ç…§ `npm2` çš„æ–¹å¼ä¾æ¬¡æŒ‚åœ¨ä¾èµ–åŒ…ç›®å½•ä¸‹,è¿™æ ·å¤„ç†çš„åŸç†éµå¾ªäº†[`Nodejs`çš„ä¾èµ–è§£æè§„åˆ™](https://nodejs.org/api/modules.html#all-together)ï¼š**å½“å‰ç›®å½•ä¸‹æ²¡æœ‰æ‰¾åˆ°`node_modules`ï¼Œå®ƒå°†é€’å½’è§£æçˆ¶ç›®å½•ä¸‹çš„`node_modules`**ã€‚

ä½¿ç”¨ `npm3` å®‰è£…ä¾èµ–åå¦‚ä¸‹å›¾ï¼š

![](https://tva1.sinaimg.cn/large/008i3skNgy1gyt34x0kxwj31me0hggng.jpg)

è¿™ç§æ‰å¹³åŒ–å¤„ç†æ–¹å¼ä¸€å®šç¨‹åº¦ä¸Šç¼“è§£äº†å†—ä½™å’Œä¾èµ–æ ‘é—®é¢˜ï¼ŒåŒæ—¶ `npm3` è¿˜æ”¯æŒåŠ¨æ€å®‰è£…æ›´æ–°åŒ…ï¼Œå¦‚æœä¾èµ–æœ‰æ›´æ–°ï¼Œå¯ä»¥é€šè¿‡ `npm dedupe` å‘½ä»¤å¯¹ä¾èµ–æ ‘è¿›è¡Œä¼˜åŒ–ã€‚

ä½†æ˜¯ `npm3` ä¹Ÿå­˜åœ¨éƒ¨åˆ†é—®é¢˜ï¼Œæ¯”å¦‚ï¼š

- [phantom_deps(å¹»å½±ä¾èµ–)](https://rushjs.io/pages/advanced/phantom_deps/)ã€‚**`npm3`ä¸ä¼šä»¥ç¡®å®šçš„æ–¹å¼å®‰è£…ä¾èµ–é¡¹**ã€‚ä¸¾ä¾‹æ¥è¯´ï¼šæˆ‘ä»¬åœ¨ `NodeJS` ä¸­ `require()` çš„å‡½æ•°ï¼Œä¸éœ€è¦è€ƒè™‘é…ç½®æ–‡ä»¶ `package.json` ä¸­æ˜¯å¦æœ‰è¯¥ä¾èµ–é¡¹ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´ä¾èµ–ç‰ˆæœ¬ä¸å…¼å®¹ï¼Œå¹¶ä¸”å¼€å‘è€…ä¸å®¹æ˜“å‘ç°ï¼›å¦å¤–ï¼Œç”±äº[`Nodejs`çš„ä¾èµ–è§£æè§„åˆ™](https://nodejs.org/api/modules.html#all-together)ï¼Œè¿™è¿˜ä¼šå¯¼è‡´å¹»å½± `node_modules` ï¼Œå³ä¾èµ–å‘ä¸ŠæŸ¥æ‰¾ï¼Œå¯èƒ½ä¼šè¶Šè¿‡ä»£ç ç›®å½•è‡ªèº«çš„ `node_modules` ã€‚å¦‚ä¸‹ï¼š

```json
- my-monorepo/
  - package.json
  - node_modules/
    - semver/
    - ...
  - my-monorepo/my-library/
    - package.json
    - lib/
      - index.js
    - node_modules/
      - brace-expansion
      - minimatch
      - ...
```
`my-monorepo/my-library/lib/index.js` å¯èƒ½ä½¿ç”¨çš„æ˜¯`my-monorepo/node_modules` ä¸­çš„ä¾èµ–ï¼Œè€Œéè‡ªèº«ç›®å½• `my-monorepo/my-library/node_modules`

- [npm doppelgangers(npm åˆ†èº«)](https://rushjs.io/pages/advanced/npm_doppelgangers/)ã€‚ç®€å•æ¥è®²ï¼Œnpm åˆ†èº«æ˜¯æŒ‡åŒä¸€ä¸ªä¾èµ–çš„ä¸åŒç‰ˆæœ¬ä¼šå‡ºç°åœ¨ `node_modules` ä¸­ï¼Œæ¯”å¦‚é¡¹ç›®ä¸­åŒæ—¶ä¾èµ–äº† `A@1.0.0` å’Œ `A@2.0.0`ï¼Œæ— è®ºæ˜¯æ‰å¹³åŒ–å¤„ç†`A@1.0.0` æˆ– `A@2.0.0`ï¼Œå¦ä¸€ä¸ªä¾èµ–è¿˜æ˜¯ä¼šè¢«é‡å¤ï¼Œå¦‚æœè¿™æ ·çš„åˆ†èº«è¾ƒå¤šï¼Œå°±ä¼šå¯¼è‡´ä¸€äº›æ½œåœ¨é—®é¢˜ï¼Œæ¯”å¦‚æ‰©å±•åŒ…å¤§å°å˜å¤§ã€ç›¸å…³ç±»å‹æ ¡éªŒäº¤å‰ç­‰

### npm5
npm5 é€šè¿‡æ·»åŠ  `lock` æ–‡ä»¶æ¥è®°å½•ä¾èµ–æ ‘ä¿¡æ¯ï¼Œè¿›è¡Œä¾èµ–é”å®š,ä»è€Œå”¯ä¸€ç¡®å®š `node_modules` çš„ç»“æ„,è¿™æ ·å¤„ç†å¯ä»¥ä¿è¯å›¢é˜Ÿæˆå‘˜ä½¿ç”¨åŒä¸€ä»½`node_modules`ä¾èµ–ç»“æ„ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å‰æ–‡æåˆ°çš„å¹³é“ºå¼çš„ç®—æ³•çš„å¤æ‚æ€§ã€å¹»å½±ä¾èµ–å’Œåˆ†èº«é—®é¢˜ä»ç„¶æ²¡æœ‰è§£å†³ã€‚

## pnpm ç®€ä»‹
å‰æ–‡æˆ‘ä»¬å¤§è‡´æ¢³ç†äº† `npm` çš„å‘å±•å’Œé—ç•™é—®é¢˜ã€‚è€Œ `pnpm` æ¯”è¾ƒå·§å¦™åœ°è§£å†³äº†å®ƒä»¬ï¼Œå¹¶ä¸”æå¤§åœ°æå‡äº†ä¾èµ–åŒ…ç®¡ç†çš„æ•ˆç‡ã€‚

`pnpm` æŒ‡ `performant npm`ï¼ˆé«˜æ€§èƒ½çš„ npmï¼‰ï¼Œå¦‚ [pnpm å®˜ç½‘](https://pnpm.io/)æ‰€è¨€ï¼Œå®ƒæ˜¯**å¿«é€Ÿçš„ï¼ŒèŠ‚çœç£ç›˜ç©ºé—´çš„åŒ…ç®¡ç†å·¥å…·**ï¼ŒåŒæ—¶ï¼Œå®ƒä¹Ÿè¾ƒå¥½åœ°æ”¯æŒäº† `workspace` å’Œ `monorepos`ã€‚

![](https://tva1.sinaimg.cn/large/008i3skNgy1gyt34xkxo6j31hc0u0jwy.jpg)

ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœé¡¹ç›®ä¸­ï¼Œä½ ä½¿ç”¨äº†æŸä¸ªä¾èµ–é¡¹çš„å¤šä¸ªç‰ˆæœ¬ï¼Œé‚£ä¹ˆ `pnpm` åªä¼šå°†æœ‰å·®å¼‚çš„æ–‡ä»¶æ·»åŠ åˆ°ä»“åº“ã€‚å¦‚æœæŸä¸ªä¾èµ–åŒ…æœ‰ 100 ä¸ªæ–‡ä»¶ï¼Œè€Œå®ƒçš„æ–°ç‰ˆæœ¬åªæ”¹å˜äº†å…¶ä¸­ 1 ä¸ªæ–‡ä»¶ã€‚é‚£ä¹ˆ `pnpm update` æ—¶åªä¼šæ·»åŠ  1 ä¸ªæ–°æ–‡ä»¶ï¼Œè€Œä¸ä¼šå¤åˆ¶æ•´ä¸ªæ–°ç‰ˆæœ¬çš„æ‰€æœ‰åŒ…ã€‚æ­¤å¤–ã€‚æ‰€æœ‰æ–‡ä»¶éƒ½ä¼šå­˜å‚¨åœ¨ç¡¬ç›˜ä¸Šçš„æŸä¸€ä½ç½®ã€‚ å½“ä¾èµ–åŒ…è¢«è¢«å®‰è£…æ—¶ï¼Œå…¶ä¸­çš„æ–‡ä»¶ä¼šç¡¬é“¾æ¥åˆ°è¿™ä¸€ä½ç½®ï¼Œè€Œä¸ä¼šå ç”¨é¢å¤–çš„ç£ç›˜ç©ºé—´ã€‚åŒæ—¶ï¼Œé¡¹ç›®ä¸­å…è®¸å…±äº«åŒä¸€ç‰ˆæœ¬çš„ä¾èµ–ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å…ˆäº†è§£ä¸‹ `pnpm` çš„ä½¿ç”¨æ•ˆæœ

## pnpm æ•ˆæœ
> ä¸ npmã€yarnã€yarn pnp å·¥å…·é“¾æ•ˆæœå¯¹æ¯”ï¼Œæ¥è‡ª [pnpm benchmarks](https://pnpm.io/zh/benchmarks)

<table><thead>
<tr><th>action</th><th>cache</th><th>lockfile</th><th>node_modules</th><th>npm</th><th>pnpm</th><th>Yarn</th><th>Yarn PnP</th></tr></thead><tbody><tr><td>install</td><td></td><td></td><td></td><td>1m 9.5s</td><td>15.3s</td><td>16.6s</td><td>23.6s</td></tr><tr><td>install</td><td>âœ”</td><td>âœ”</td><td>âœ”</td><td>2.4s</td><td>1.3s</td><td>2.3s</td><td>n/a</td></tr><tr><td>install</td><td>âœ”</td><td>âœ”</td><td></td><td>14.8s</td><td>4s</td><td>6.8s</td><td>1.5s</td></tr><tr><td>install</td><td>âœ”</td><td></td><td></td><td>21.8s</td><td>8.9s</td><td>11.2s</td><td>6.2s</td></tr><tr><td>install</td><td></td><td>âœ”</td><td></td><td>35.4s</td><td>13.4s</td><td>12s</td><td>17.9s</td></tr><tr><td>install</td><td>âœ”</td><td></td><td>âœ”</td><td>3.1s</td><td>1.9s</td><td>7s</td><td>n/a</td></tr><tr><td>install</td><td></td><td>âœ”</td><td>âœ”</td><td>2.4s</td><td>1.3s</td><td>7.6s</td><td>n/a</td></tr><tr><td>install</td><td></td><td></td><td>âœ”</td><td>3s</td><td>6.1s</td><td>11.8s</td><td>n/a</td></tr><tr><td>update</td><td>n/a</td><td>n/a</td><td>n/a</td><td>2.3s</td><td>11.8s</td><td>15.5s</td><td>28.3s</td></tr>
</tbody></table>

ä»ä¸Šè¡¨æ•°æ®æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œ`pnpm` çš„å„é¡¹æ€§èƒ½å‡æ¯”å…¶å®ƒåŒ…ç®¡ç†å·¥å…·æœ‰ä¼˜åŠ¿ï¼Œé‚£ä½ å¯èƒ½ä¼šæƒ³ï¼Œä¸ºä»€ä¹ˆ `pnpm` æœ‰å¦‚æ­¤ä¼˜è¶Šçš„è¡¨ç°ğŸ¤”ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬èŠèŠ `pnpm` çš„ä¸»è¦åŸç†

## pnpm çš„åŸç†

`pnpm` ä¸»è¦æœ‰ä¸¤ä¸ªä¸åŒä¸å…¶åŒ…ç®¡ç†å·¥å…·çš„ç‰¹æ€§ï¼š

### åŸºäºç¡¬é“¾æ¥çš„ `node_modules`
`pnpm` åˆ›å»ºä»å…¨å±€å­˜å‚¨åˆ°é¡¹ç›®ä¸­ `node_modules` æ–‡ä»¶å¤¹çš„[ç¡¬é“¾æ¥](https://zh.wikipedia.org/wiki/%E7%A1%AC%E9%93%BE%E6%8E%A5)ï¼Œè€Œç¡¬é“¾æ¥æŒ‡å‘ç£ç›˜ä¸ŠåŸå§‹æ–‡ä»¶æ‰€åœ¨çš„åŒä¸€ä½ç½®ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯ `node_modules` ä¸­æ¯ä¸ªåŒ…çš„æ¯ä¸ªæ–‡ä»¶éƒ½æ˜¯æ¥è‡ª[å†…å®¹å¯å¯»å€å­˜å‚¨](https://en.wikipedia.org/wiki/Content-addressable_storage)çš„ç¡¬é“¾æ¥ï¼Œç®€è¨€ä¹‹ï¼Œå°±æ˜¯ç‰¹å®šç‰ˆæœ¬å’Œåç§°çš„åŒ…å…¨å±€åªæœ‰ä¸€ä»½ã€‚ä¸¾ä¾‹æ¥çœ‹ï¼š

```file
node_modules
â””â”€â”€ .pnpm
    â”œâ”€â”€ bar@1.0.0
    â”‚   â””â”€â”€ node_modules
    â”‚       â””â”€â”€ bar -> <store>/bar
    â”‚           â”œâ”€â”€ index.js
    â”‚           â””â”€â”€ package.json
    â””â”€â”€ foo@1.0.0
        â””â”€â”€ node_modules
            â””â”€â”€ foo -> <store>/foo
                â”œâ”€â”€ index.js
                â””â”€â”€ package.json
```
`node_modules` ä¸‹é¢çš„å”¯ä¸€æ–‡ä»¶å¤¹å«åš `.pnpm`, `.pnpm` ä¸‹é¢æ˜¯ä¸€ä¸ª `<PACKAGE_NAMEï¼ VERSION>` æ–‡ä»¶å¤¹ï¼Œè€Œåœ¨å…¶ä¸‹é¢ `<PACKAGE_NAME>` çš„æ–‡ä»¶å¤¹æ˜¯ä¸€ä¸ªåŸºäºå†…å®¹å¯å¯»å€å­˜å‚¨çš„ç¡¬é“¾æ¥ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ `pnpm root` å‘½ä»¤æ¥æ‰“å°å½“å‰é¡¹ç›®ä¸­å­˜æ”¾æ¨¡å—ï¼ˆmodulesï¼‰çš„æœ‰æ•ˆç›®å½•

### åŸºäºä¾èµ–è§£æçš„è½¯é“¾æ¥ symlinks
è§‚å¯Ÿä»¥ä¸‹ä¾èµ–åŒ…ç»“æ„
```file
node_modules
â”œâ”€â”€ foo -> ./.pnpm/foo@1.0.0/node_modules/foo
â””â”€â”€ .pnpm
    â”œâ”€â”€ bar@1.0.0
    â”‚   â””â”€â”€ node_modules
    â”‚       â””â”€â”€ bar -> <store>/bar
    â””â”€â”€ foo@1.0.0
        â””â”€â”€ node_modules
            â”œâ”€â”€ foo -> <store>/foo
            â””â”€â”€ bar -> ../../bar@1.0.0/node_modules/bar
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ `foo@1.0.0/node_modules/bar` å†…å¼•ç”¨äº† `bar` çš„è½¯é“¾æ¥ `../../bar@1.0.0/node_modules/bar`ï¼Œè€Œåœ¨é¡¹ç›®é‡Œå¼•ç”¨ `foo` çš„è½¯é“¾æ¥ `./.pnpm/foo@1.0.0/node_modules/foo`ï¼Œå¦‚æœé¡¹ç›®å†…æ–°å¢ä¸€ä¸ªä¾èµ–åŒ… `qar@2.0.0`ï¼Œåˆ™å…¶å¼•ç”¨ç»“æ„å¦‚ä¸‹ï¼š

```file
node_modules
â”œâ”€â”€ foo -> ./.pnpm/foo@1.0.0/node_modules/foo
â””â”€â”€ .pnpm
    â”œâ”€â”€ bar@1.0.0
    â”‚   â””â”€â”€ node_modules
    â”‚       â”œâ”€â”€ bar -> <store>/bar
    â”‚       â””â”€â”€ qar -> ../../qar@2.0.0/node_modules/qar
    â”œâ”€â”€ foo@1.0.0
    â”‚   â””â”€â”€ node_modules
    â”‚       â”œâ”€â”€ foo -> <store>/foo
    â”‚       â”œâ”€â”€ bar -> ../../bar@1.0.0/node_modules/bar
    â”‚       â””â”€â”€ qar -> ../../qar@2.0.0/node_modules/qar
    â””â”€â”€ qar@2.0.0
        â””â”€â”€ node_modules
            â””â”€â”€ qar -> <store>/qar
```
æ ¹æ®å‰æ–‡æˆ‘ä»¬ä»‹ç»åˆ°çš„[`Nodejs`çš„ä¾èµ–è§£æè§„åˆ™](https://nodejs.org/api/modules.html#all-together)ï¼Œ`foo@1.0.0/node_modules/foo/index.js` ä¸­æ‰€éœ€çš„ä¾èµ–åŒ… `bar`ï¼Œå®é™…ä¸Šä½¿ç”¨çš„æ˜¯`bar@1.0.0/node_modules/bar`ä¸­çš„å†…å®¹ï¼Œå› æ­¤ï¼Œåªæœ‰**çœŸæ­£åœ¨ä¾èµ–é¡¹ä¸­çš„åŒ…æ‰èƒ½è¢«è®¿é—®åˆ°**ã€‚è€Œå¯¹äºä¸åŒçš„ `peer dependencies` çš„ä¾èµ–è§£æåŸç†ï¼Œå¯ä»¥å‚è€ƒè¿™é‡Œ [How peers are resolved](https://pnpm.io/zh/how-peers-are-resolved)

é€šè¿‡**åŸºäºç¡¬é“¾æ¥çš„`node_modules`**å’Œ**åŸºäºä¾èµ–è§£æçš„è½¯é“¾æ¥**åŸç†ï¼Œæˆ‘ä»¬äº†è§£åˆ°ï¼Œå½“æˆ‘ä»¬åœ¨ç›¸åŒæ“ä½œç³»ç»Ÿä¸‹ç¬¬äºŒæ¬¡å®‰è£…åŒä¸€ä¸ªä¾èµ–åŒ…æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åšçš„ä»…ä»…æ˜¯åˆ›å»ºä¸€ä¸ªè¯¥ä¾èµ–åŒ…å¯¹åº”çš„ç¡¬é“¾æ¥ï¼Œå¯¹äºåŒä¸€ä¸ªä¾èµ–åŒ…çš„ä¸åŒç‰ˆæœ¬ï¼Œä¹Ÿåªæœ‰ä¸åŒçš„éƒ¨åˆ†ä¼šè¢«é‡æ–°ä¿å­˜èµ·æ¥ï¼Œè€Œå…·ä½“æœ‰æ²¡æœ‰ `pnpm` æ˜¯åœ¨å“ªé‡Œåˆ¤æ–­çš„å‘¢ï¼Ÿå…¨å±€çš„ `pnpm` ç´¢å¼•æ–‡ä»¶åœ¨ `ï½/.pnpm-store/v3/files`ã€‚åŸºäºæ­¤ï¼Œä½¿ç”¨ç¡¬é“¾æ¥è®©ä¾èµ–åŒ…çš„å®‰è£…é€Ÿåº¦éå¸¸å¿«ï¼ŒåŒæ—¶ä¹Ÿå»é™¤äº†å†—ä½™ï¼ŒèŠ‚çœè¾ƒå¤§ç£ç›˜ç©ºé—´ã€‚

> [symlinks ç¬¦å·è¿æ¥](https://zh.wikipedia.org/wiki/%E7%AC%A6%E5%8F%B7%E9%93%BE%E6%8E%A5)

## pnpm ä½¿ç”¨
pnpm çš„å…·ä½“ä½¿ç”¨è¿™é‡Œæˆ‘ä»¬ä¸å±•å¼€ä»‹ç»äº†ï¼Œå¯ä»¥æŸ¥çœ‹å®˜ç½‘[ä½¿ç”¨æ–¹æ³•](https://pnpm.io/zh/pnpm-cli)å’Œ[CLI å‘½ä»¤](https://pnpm.io/zh/cli/add)å³å¯ã€‚è¿™é‡Œåªæå‡ ä¸ªæœ‰æ„æ€çš„ç‚¹

### CI é›†æˆ
åœ¨ `GitHub Actions` ä¸Šï¼Œä½ å¯ä»¥åƒè¿™æ ·ä½¿ç”¨ `pnpm` å®‰è£…å’Œç¼“å­˜ä¾èµ–é¡¹ï¼Œé…ç½®æ–‡ä»¶ç›®å½•ï¼š `.github/workflows/NAME.yml`

```yml
name: pnpm Example Workflow
on:
  push:
jobs:
  build:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        node-version: [15]
    steps:
    - uses: actions/checkout@v2
    - uses: pnpm/action-setup@v2.0.1
      with:
        version: 6.20.3
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v2
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'pnpm'
    - name: Install dependencies
      run: pnpm install
```
`pnpm` é™¤äº†åœ¨å¼€å‘ä½“éªŒæ–¹é¢çš„ä¼˜è¶Šè¡¨ç°ï¼Œåœ¨é¡¹ç›®é›†æˆæ–¹é¢ä¹Ÿæ¯«ä¸é€Šè‰²ï¼Œå¯¹äºè¾ƒå¤§å‹é¡¹ç›®ä» `npm æˆ– yarn`åˆ°`pnpm`è¿ç§»è¿‡ç¨‹åï¼Œä¹Ÿå¾—åˆ°äº†æå¤§çš„ä¼˜åŒ–ï¼Œç»“æœå¦‚ä¸‹ï¼š
<table>
<thead>
<tr>
<th align="none"></th>
<th align="none">Without cache</th>
<th align="none">With cache</th>
</tr>
</thead>
<tbody>
<tr>
<td align="none">yarn 2 (without dedupe)</td>
<td align="none">6min 31s</td>
<td align="none">1min 11s</td>
</tr>
<tr>
<td align="none">yarn 3 (without dedupe)</td>
<td align="none">4min 50s</td>
<td align="none">57s</td>
</tr>
<tr>
<td align="none">yarn 3</td>
<td align="none">4min 1s</td>
<td align="none">50s</td>
</tr>
<tr>
<td align="none">yarn 3 (optimized)</td>
<td align="none">1min 10</td>
<td align="none">45s</td>
</tr>
<tr>
<td align="none">pnpm</td>
<td align="none">58s</td>
<td align="none">24s</td>
</tr>
</tbody>
</table>

é€šè¿‡ä»¥ä¸Šæ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥ `pnpm` åœ¨ CI åº”ç”¨ä¸­çš„è‰¯å¥½è¡¨ç°ã€‚
> å…·ä½“å¯ä»¥å‚è€ƒè¿™ç¯‡æœ€ä½³å®è·µ [A story of how we migrated to pnpm](https://divriots.com/blog/switching-to-pnpm)

### pnpm å‰ç½®

é¡¹ç›®ä¸­ä½¿ç”¨ `pnpm` æ—¶ï¼Œå¦‚æœä½ ä¸å¸Œæœ›é¡¹ç›®å†…å…¶ä»–äººä½¿ç”¨ `npm i` æˆ– `yarn`è¿™ç±»åŒ…ç®¡ç†å™¨ï¼Œå¯ä»¥åœ¨ `package.json` é…ç½®æ–‡ä»¶ä¸­æ·»åŠ é¢„å®‰è£… `preinstall` é…ç½®é¡¹ï¼Œä»è€Œè§„èŒƒä½¿ç”¨ç»Ÿä¸€çš„åŒ…ç®¡ç†å™¨ã€‚
 
```json
{
    "scripts": {
        "preinstall": "npx only-allow pnpm"
    }
}
```

### ç®¡ç† NodeJS ç‰ˆæœ¬
åœ¨ä»¥å‰ï¼Œå¦‚æœä½ åŒæ—¶æ”¯æ’‘äº†å¤šä¸ªé¡¹ç›®ï¼Œè€Œä¸”éœ€è¦åœ¨å…¶ä¸­åˆ‡æ¢ä¸­ï¼Œä½ å¯èƒ½éœ€è¦åˆ‡æ¢ä¸åŒçš„ `NodeJS` ç‰ˆæœ¬ï¼Œä¹Ÿè®¸ä½ ä¼šç”¨åˆ°åƒ `nvm` æˆ– [Volta](https://volta.sh/) è¿™æ ·çš„ `NodeJS` ç‰ˆæœ¬ç®¡ç†å™¨ï¼Œè€Œ `pnpm` ä» `v6.12.0` ç‰ˆæœ¬åæ”¯æŒäº† [pnpm env](https://pnpm.io/zh/cli/env) å‘½ä»¤ï¼Œä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥å®‰è£…å¹¶æŒ‡å®šä½¿ç”¨å“ªä¸ªç‰ˆæœ¬çš„ `NodeJS` ï¼Œæ˜¯ä¸æ˜¯æ–¹ä¾¿äº†å¾ˆå¤šã€‚

### monorepo æ”¯æŒ
å› ä¸º`pnpm` å¯¹ `monorepos` çš„å¤§åŠ›æ”¯æŒï¼Œåƒ `Vue`ã€`Vite` è¿™äº›å¼€æºé¡¹ç›®ä¹Ÿè½¬è€Œä½¿ç”¨äº†å®ƒã€‚ä½¿ç”¨`pnpm run` ç»“åˆ `--filter` ã€ `--recursive` å’Œ `--parallel` é€‰é¡¹ï¼Œå¯ä»¥æŒ‡å®šç‰¹å®šåŒ…ï¼Œå¹¶é«˜é€Ÿæ‰§è¡Œç›¸å…³å‘½ä»¤ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ä¹‹å‰è¦å¦å¤–å®‰è£… `lerna` è¿™ç§ `monorepo` ç®¡ç†å·¥å…·çš„åœºæ™¯ï¼Œç°åœ¨ `pnpm` å¯ä»¥åŒ…æ½äº†ã€‚è¯¦ç»†æ–‡ç« å¯ä»¥å‚è€ƒè¿™é‡Œ [pnpm vs Lerna: filtering in a multi-package repository](https://medium.com/pnpm/pnpm-vs-lerna-filtering-in-a-multi-package-repository-1f68bc644d6a)

## æ€»ç»“
æœ¬æ–‡ä» `pnpm` çš„å‡ºç°èƒŒæ™¯å¼€å§‹ï¼Œç®€è¦ä»‹ç»äº† `npm` çš„å‘å±•è¿‡ç¨‹åŠå­˜åœ¨çš„é—®é¢˜ï¼Œç»§è€Œå¯¹ `pnpm` åŠå…¶æ•ˆæœè¿›è¡Œäº†ç®€ä»‹ï¼Œé‡ç‚¹è®²è¿°äº† `pnpm` çš„å®ç°åŸç†ï¼Œå¹¶ä»åº”ç”¨ä¾§é€‰æ‹©äº†å››ä¸ªç‚¹å±•å¼€ã€‚`pnpm` ä½œä¸ºæ–°ä¸€ä»£åŒ…ç®¡ç†å™¨ï¼Œè‡ªèº«æœ‰ä¸å°‘ä¼˜è¶Šçš„è¡¨ç°ï¼Œå®ƒé€šè¿‡ç¡¬é“¾æ¥å’Œè½¯é“¾æ¥çš„æ–¹å¼ï¼Œè§£å†³äº† `npm` å¹»å½±ä¾èµ–å’Œåˆ†èº«é—®é¢˜ï¼Œå¹¶ä¸”è¾ƒå¥½åœ°è§£å†³äº†ä¾èµ–åŒ…å¤ç”¨é—®é¢˜ï¼Œä»è€Œå®ç°äº†ä¾èµ–åŒ…é«˜æ•ˆå¿«é€Ÿçš„å®‰è£…ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ `pnpm` ä¸¥æ ¼éµå¾ªäº† `Nodejs` ä¾èµ–è§£æè§„åˆ™ï¼Œè§„é¿äº†ä¹‹å‰ä»»æ„ä¾èµ–åŒ…çš„è®¿é—®ä¿®æ”¹é—®é¢˜ã€‚

å½“ç„¶ï¼Œ`pnpm` ä½¿ç”¨è¿‡ç¨‹ä¸­ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ï¼ŒåŒ…æ‹¬ `Vue` å®˜æ–¹åœ¨è¿ç§»è¿‡ç¨‹ä¸­ï¼Œä¹Ÿå¤„ç†è¿‡éƒ¨åˆ†é—®é¢˜ã€‚å¦å¤–ï¼Œä¸€äº›åŒ…ä¹Ÿå­˜åœ¨å…¼å®¹æ€§é—®é¢˜ï¼Œç”±äºåŒ…è‡ªå·±å®ç°äº†æ¨¡å—è§£æï¼Œå¹¶æ²¡æœ‰éµå¾ªç›¸å…³è§„èŒƒã€‚ä½† `pnpm` ä¹Ÿæä¾›äº†ç›¸å…³è§£å†³æ–¹æ³•ã€‚å…·ä½“å‚è€ƒ [pnpm FAQ](https://pnpm.io/faq#pnpm-does-not-work-with-your-project-here)

ç»¼ä¸Šï¼Œ`pnpm` æ˜¯ä¸€ä¸ªåŠŸèƒ½å…¨é¢ï¼Œæ€§èƒ½ä¼˜è¶Šçš„åŒ…ç®¡ç†å™¨ï¼Œå¿«æ¥ä½“éªŒ `pnpm` å§ã€‚

## å‚è€ƒèµ„æ–™
- [npm å­˜åœ¨çš„é—®é¢˜ä»¥åŠ pnpm æ˜¯æ€ä¹ˆå¤„ç†çš„](https://www.yuexunjiang.me/blog/problems-with-npm-and-how-pnpm-handles-them/)
- [npm/yarn çš„è®¾è®¡ç¼ºé™·ï¼Œä»¥åŠ pnpm æ˜¯å¦‚ä½•æ”¹è¿›çš„](https://xingyahao.com/c/pnpm-npm-yarn.html)